<!doctype html>
<html lang="{{ request.cookies.get('lang', 'hr') }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ _("Upload File") }}</title>
    <!-- Bootstrap CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container my-5 position-relative">
      <!-- Language Switcher -->
      <div class="position-absolute top-0 end-0 m-3">
        <div class="btn-group" role="group" aria-label="Language Switcher">
          <a href="{{ url_for('set_language', lang='hr') }}" class="btn btn-sm {{ 'btn-primary' if request.cookies.get('lang') == 'hr' else 'btn-outline-primary' }}">HR</a>
          <a href="{{ url_for('set_language', lang='en') }}" class="btn btn-sm {{ 'btn-primary' if request.cookies.get('lang') == 'en' else 'btn-outline-primary' }}">EN</a>
        </div>
      </div>
      <!-- Navigation Menu -->
      <nav class="mb-4">
        <div class="d-flex">
          <a href="{{ url_for('upload_file') }}" class="btn btn-primary me-2">{{ _("Home") }}</a>
          <a href="{{ url_for('view_logs') }}" class="btn btn-secondary">{{ _("View Logs") }}</a>
        </div>
      </nav>
      
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h2 class="mb-0">{{ _("Upload File") }}</h2>
        </div>
        <div class="card-body">
          {% if success_message %}
            <div class="alert alert-success" role="alert">
              {{ success_message|safe }}
            </div>
          {% endif %}
          <form id="uploadForm" method="post" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="file" class="form-label">{{ _("Choose file:") }}</label>
              <input type="file" name="file" id="file" class="form-control" required>
              <small class="text-muted">{{ _("Allowed file types: txt, pdf, png, jpg, jpeg, gif, doc, docx, xls, xlsx, zip (Max 10MB)") }}</small>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">{{ _("Enter password:") }}</label>
              <input type="password" name="password" id="password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">{{ _("Upload") }}</button>
          </form>
          <!-- Add a div to display the success message -->
          <div id="successMessage" class="alert alert-success mt-3" style="display: none;"></div>
          <!-- Add a progress bar -->
          <div class="progress mt-3" id="progressContainer" style="display: none;">
            <div class="progress-bar" role="progressbar" id="progressBar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
          </div>
          <!-- Add a div to display client-side validation errors -->
          <div id="validationErrors" class="alert alert-danger mt-3" style="display: none;"></div>
          {% with messages = get_flashed_messages() %}
            {% if messages %}
              <div class="mt-3">
                {% for message in messages %}
                  <div class="alert alert-warning">{{ message }}</div>
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
    <!-- Bootstrap JS Bundle from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Add JavaScript for AJAX form submission -->
    <script>
      // Define allowed file extensions
      const allowedExtensions = ['txt', 'pdf', 'png', 'jpg', 'jpeg', 'gif', 'doc', 'docx', 'xls', 'xlsx', 'zip'];
      const maxFileSize = 10 * 1024 * 1024; // 10MB
      
      // Function to validate the file
      function validateFile(file) {
        // Check if file is selected
        if (!file) {
          return { valid: false, message: "{{ _('Please select a file.') }}" };
        }
        
        // Check file size
        if (file.size > maxFileSize) {
          return { valid: false, message: "{{ _('File size exceeds the 10MB limit. Your file is') }} " + (file.size / (1024 * 1024)).toFixed(2) + "MB." };
        }
        
        // Check file extension
        const fileName = file.name;
        const fileExt = fileName.split('.').pop().toLowerCase();
        
        if (!allowedExtensions.includes(fileExt)) {
          return { valid: false, message: "{{ _('File type') }} \"" + fileExt + "\" {{ _('is not allowed. Allowed types:') }} " + allowedExtensions.join(', ') };
        }
        
        return { valid: true };
      }
      
      document.getElementById('uploadForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission
        
        // Hide any previous messages
        document.getElementById('validationErrors').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';
        
        // Get the file and password
        const fileInput = document.getElementById('file');
        const passwordInput = document.getElementById('password');
        const file = fileInput.files[0];
        const password = passwordInput.value.trim();
        
        // Validate password
        if (!password) {
          document.getElementById('validationErrors').textContent = "{{ _('Please enter a password.') }}";
          document.getElementById('validationErrors').style.display = 'block';
          return;
        }
        
        // Validate file
        const fileValidation = validateFile(file);
        if (!fileValidation.valid) {
          document.getElementById('validationErrors').textContent = fileValidation.message;
          document.getElementById('validationErrors').style.display = 'block';
          return;
        }
        
        // If validation passes, proceed with form submission
        const formData = new FormData(this);
        
        // Create AJAX request
        const xhr = new XMLHttpRequest();
        
        // Configure the request
        xhr.open('POST', window.location.href, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        
        // Setup progress event
        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');
            
            progressBar.style.width = percentComplete + '%';
            progressBar.setAttribute('aria-valuenow', percentComplete);
            progressBar.textContent = Math.round(percentComplete) + '%';
            progressContainer.style.display = 'block';
          }
        });
        
        // Setup load event
        xhr.addEventListener('load', function() {
          if (xhr.status === 200) {
            try {
              const response = JSON.parse(xhr.responseText);
              if (response.success) {
                // Display success message
                const successDiv = document.getElementById('successMessage');
                successDiv.innerHTML = response.message;
                successDiv.style.display = 'block';
                
                // Reset form
                document.getElementById('uploadForm').reset();
                
                // Hide progress bar after a delay
                setTimeout(function() {
                  document.getElementById('progressContainer').style.display = 'none';
                }, 3000);
              } else {
                // Display error message
                document.getElementById('validationErrors').textContent = response.message || "{{ _('An error occurred during upload.') }}";
                document.getElementById('validationErrors').style.display = 'block';
                document.getElementById('progressContainer').style.display = 'none';
              }
            } catch (e) {
              // Handle non-JSON response (possibly HTML)
              const successDiv = document.getElementById('successMessage');
              successDiv.innerHTML = xhr.responseText;
              successDiv.style.display = 'block';
            }
          } else {
            // Handle error
            document.getElementById('validationErrors').textContent = "{{ _('An error occurred during upload. Please try again.') }}";
            document.getElementById('validationErrors').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'none';
          }
        });
        
        // Setup error event
        xhr.addEventListener('error', function() {
          document.getElementById('validationErrors').textContent = "{{ _('Network error occurred during upload. Please try again.') }}";
          document.getElementById('validationErrors').style.display = 'block';
          document.getElementById('progressContainer').style.display = 'none';
        });
        
        // Send the request
        xhr.send(formData);
      });
      
      // Add event listener to file input to validate file on selection
      document.getElementById('file').addEventListener('change', function() {
        const file = this.files[0];
        const validationErrors = document.getElementById('validationErrors');
        
        const fileValidation = validateFile(file);
        if (!fileValidation.valid) {
          validationErrors.textContent = fileValidation.message;
          validationErrors.style.display = 'block';
          this.value = ''; // Clear the file input
        } else {
          validationErrors.style.display = 'none';
        }
      });
    </script>
  </body>
</html>