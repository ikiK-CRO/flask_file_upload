<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Upload File</title>
    <!-- Bootstrap CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container my-5">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h2 class="mb-0">Upload File</h2>
        </div>
        <div class="card-body">
          {% if success_message %}
            <div class="alert alert-success" role="alert">
              {{ success_message|safe }}
            </div>
          {% endif %}
          <form id="uploadForm" method="post" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="file" class="form-label">Choose file:</label>
              <input type="file" name="file" id="file" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Enter password:</label>
              <input type="password" name="password" id="password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Upload</button>
          </form>
          <!-- Add a div to display the success message -->
          <div id="successMessage" class="alert alert-success mt-3" style="display: none;"></div>
          <!-- Add a progress bar -->
          <div class="progress mt-3" id="progressContainer" style="display: none;">
            <div class="progress-bar" role="progressbar" id="progressBar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
          </div>
          {% with messages = get_flashed_messages() %}
            {% if messages %}
              <div class="mt-3">
                {% for message in messages %}
                  <div class="alert alert-warning">{{ message }}</div>
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
    <!-- Bootstrap JS Bundle from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Add JavaScript for AJAX form submission -->
    <script>
      document.getElementById('uploadForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission
        
        // Get form data
        const formData = new FormData(this);
        
        // Create AJAX request
        const xhr = new XMLHttpRequest();
        
        // Configure the request
        xhr.open('POST', window.location.href, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        
        // Setup progress event
        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');
            
            progressBar.style.width = percentComplete + '%';
            progressBar.setAttribute('aria-valuenow', percentComplete);
            progressBar.textContent = Math.round(percentComplete) + '%';
            progressContainer.style.display = 'block';
          }
        });
        
        // Setup load event
        xhr.addEventListener('load', function() {
          if (xhr.status === 200) {
            try {
              const response = JSON.parse(xhr.responseText);
              if (response.success) {
                // Display success message
                const successDiv = document.getElementById('successMessage');
                successDiv.innerHTML = response.message;
                successDiv.style.display = 'block';
                
                // Reset form
                document.getElementById('uploadForm').reset();
                
                // Hide progress bar after a delay
                setTimeout(function() {
                  document.getElementById('progressContainer').style.display = 'none';
                }, 3000);
              } else {
                // Display error message
                alert(response.message || 'An error occurred during upload.');
              }
            } catch (e) {
              // Handle non-JSON response (possibly HTML)
              const successDiv = document.getElementById('successMessage');
              successDiv.innerHTML = xhr.responseText;
              successDiv.style.display = 'block';
            }
          } else {
            // Handle error
            alert('An error occurred during upload. Please try again.');
          }
        });
        
        // Setup error event
        xhr.addEventListener('error', function() {
          alert('Network error occurred during upload. Please try again.');
        });
        
        // Send the request
        xhr.send(formData);
      });
    </script>
  </body>
</html>